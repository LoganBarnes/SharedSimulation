version: 1.0.{build}

branches:
  only:
  - master

skip_tags: true

image: Visual Studio 2015
clone_folder: c:\projects\SharedSimulation

environment:
  matrix:
    - BUILD_MODE: Debug
      OPENGL: ON
    - BUILD_MODE: Release
      OPENGL: ON
    - BUILD_MODE: Debug
      OPENGL: OFF
    - BUILD_MODE: Release
      OPENGL: OFF

matrix:
    fast_finish: true

platform: x64

install:
  # todo: download and install vulkan here
  - SET VULKAN=OFF
  - SET SHARED=OFF

  - echo Downloading Vulkan SDK
  - appveyor DownloadFile https://www.dropbox.com/s/xrajzwwtuarpvyx/vulkan-1.0.46.0.zip?dl=1
  - 7z x vulkan-1.0.46.0.zip -ovulcaan
  - cd cuda\cuda
  - echo Installing CUDA toolkit 8
  - setup.exe -s compiler_8.0 cublas_8.0 cublas_dev_8.0 cudart_8.0 curand_8.0 curand_dev_8.0

  - echo Installing VS integration
  - copy _vs\*.* "c:\Program Files (x86)\MSBuild\Microsoft.Cpp\v4.0\V140\BuildCustomizations"

  - cd ..\..

  - set PATH=%ProgramFiles%\NVIDIA GPU Computing Toolkit\CUDA\v8.0\bin;%ProgramFiles%\NVIDIA GPU Computing Toolkit\CUDA\v8.0\libnvvp;%PATH%
  - set CUDA_PATH=%ProgramFiles%\NVIDIA GPU Computing Toolkit\CUDA\v8.0
  - set CUDA_PATH_V8_0=%ProgramFiles%\NVIDIA GPU Computing Toolkit\CUDA\v8.0

  - nvcc -V

build:
  parallel: true  # enable MSBuild parallel builds
  verbosity: minimal

build_script:
  - cd %APPVEYOR_BUILD_FOLDER%

  ############################################################################
  # Build main simulation library without tests
  ############################################################################
  - mkdir build-no-tests
  - cd build-no-tests
  - cmake -DCMAKE_GENERATOR_PLATFORM=%PLATFORM% ^
          -DCMAKE_INSTALL_PREFIX=%APPVEYOR_BUILD_FOLDER%\build-no-tests ^
          -DBUILD_SHARED_TESTS=OFF ^
          -DUSE_VULKAN=%VULKAN% ^
          -DUSE_OPENGL=%OPENGL% ^
          -DUSE_GLFW=ON ^
          -DUSE_GLM=ON ^
          -DUSE_GUI=ON ^
          -DBUILD_SHARED_LIBS=%SHARED% ^
          ..
  - cmake --build . --target INSTALL --config %BUILD_MODE% -- /m
  - cd ..

  ############################################################################
  # Build main simulation library with tests
  ############################################################################
  - mkdir build-tests
  - cd build-tests
  - cmake -DCMAKE_GENERATOR_PLATFORM=%PLATFORM% ^
          -DCMAKE_INSTALL_PREFIX=%APPVEYOR_BUILD_FOLDER%\build-tests ^
          -DBUILD_SHARED_TESTS=ON ^
          -DUSE_VULKAN=OFF ^
          -DUSE_OPENGL=OFF ^
          -DUSE_GLFW=ON ^
          -DUSE_GLM=ON ^
          -DUSE_GUI=ON ^
          -DBUILD_SHARED_LIBS=%SHARED% ^
          ..
  - cmake --build . --target INSTALL --config %BUILD_MODE% -- /m
  - cd ..

  ############################################################################
  # Build example projects using simulation library
  ############################################################################
  - cd examples
  - mkdir build
  - cd build
  - cmake -DCMAKE_GENERATOR_PLATFORM=%PLATFORM% -DBUILD_SHARED_LIBS=%SHARED% ..
  - cmake --build . --config %BUILD_MODE% -- /m

test_script:
  - cd %APPVEYOR_BUILD_FOLDER%\build-tests
  - testbin\testSharedSimulation.exe

notifications:
  - on_build_success: false
  - on_build_failure: true

